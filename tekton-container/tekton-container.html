<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">


<link rel="import" href="../tekton-login/tekton-login.html">
<link rel="import" href="../tekton-admin/tekton-admin.html">
<link rel="import" href="../tekton-user/tekton-user.html">
<link rel="import" href="../tekton-universe-selector/tekton-universe-selector.html">
<link rel="import" href="../tekton-vendor-selector/tekton-vendor-selector.html">
<link rel="import" href="../tekton-ad-selector/tekton-ad-selector.html">
<link rel="import" href="../tekton-ad-creator/tekton-ad-creator.html">
<link rel="import" href="../tekton-ad-manager/tekton-ad-manager.html">

<dom-module id="tekton-container">
    <template>
        <style>
            #container {
                border: 1px solid #ffffff;
                border-radius: 1px;
                background: white;
                height: 350px;
                width: 600px;
                position: relative;
                box-shadow: 2px 2px 20px lightslategrey;
            }

            #signOut {
                border: 1px #adadad solid;
                border-radius: 3px;
                background: white;
                width: 120px;
                position: absolute;
                right: 5px;
                top: 11px;
                color: #525252;
            }

            #back {
                border: 1px #adadad solid;
                border-radius: 3px;
                background: white;
                width: 60px;
                height: 40px;
                min-width: 1em;
                position: absolute;
                left: 5px;
                top: 11px;
                font-size: 20px;
                color: #525252;
            }

            #done {
                position: relative;
                top: 150px;
                left: 300px;
            }

            #submitted {
                position: relative;
                top: 190px;
                left: 165px;
            }

        </style>

        <firebase-app
          auth-domain={{dbConfig.authDomain}}
          database-url={{dbConfig.dbURL}}
          api-key={{dbConfig.apiKey}}
          storage-bucket={{dbConfig.storageBucket}}
          messaging-sender-id={{dbConfig.messagingSenderId}}>
        </firebase-app>

        <firebase-query id= "query" path="/users" data="{{queryData}}"></firebase-query>

        <div id="container">
            <iron-location query="{{urlQueryParamsString}}"></iron-location>

            <template is="dom-if" if="[[canSignOut]]">
                <paper-button id = "signOut" on-tap="signOut">Sign Out</paper-button>
            </template>

            <iron-pages id="pages" selected="0">
                <tekton-login id = "login"></tekton-login>
                <tekton-admin id = "admin"></tekton-admin>
                <tekton-user id = "user"></tekton-user>
                <tekton-universe-selector id="universeSelector"></tekton-universe-selector>
                <tekton-vendor-selector id="vendorSelector"></tekton-vendor-selector>
                <tekton-ad-selector id="adSelector"></tekton-ad-selector>
                <tekton-ad-creator id="adCreator"></tekton-ad-creator>
                <tekton-ad-manager id="adManager"></tekton-ad-manager>
                <div id="finished">
                    <b id="done">Done!</b>
                    <b id="submitted">Universe submitted to Facebook.</b>
                </div>
            </iron-pages>

            <template is="dom-if" if="[[canGoBack]]">
                <paper-button id="back" on-tap="goBack">Â«</paper-button>
            </template>

        </div>
    </template>

    <script>
        Polymer({
            is: "tekton-container",

            properties: {
                canSignOut: {
                    type: Boolean,
                    notify: false,
                    value: false
                },
                canGoBack: {
                    type: Boolean,
                    notify: false,
                    value: false
                },
                dbConfig: {
                  type: Object,
                  notify: true,
                  value: {
                    authDomain: "tekton-ad-module.firebaseapp.com",
                    dbURL: "https://tekton-ad-module.firebaseio.com",
                    apiKey: "AIzaSyA0RURd-YAf70pj0VvfPyQJoBMRJ7nHN-U",
                    projectId: "tekton-ad-module",
                    storageBucket: "tekton-ad-module.appspot.com",
                    messagingSenderId: "92765486328"
                  }
                },
                queryData : {
                  type: Object,
                  notify: true
                },
                urlQueryParamsObject: {
                    type: Object,
                    notify: true,
                    value: undefined
                },
                urlQueryParamsString: {
                    type: String,
                    notify: true,
                    value: undefined
                }
            },

            observers: [
                'dataChanged(queryData.*)'
            ],

            listeners: {
                'admin-signed-in': 'toggleLogin',
                'user-signed-in': 'toggleUser',
                'universe-selector-tapped': 'toggleUniverseSelector',
                'back-user-tapped': 'toggleUser',
                'next-tapped': 'toggleVendorSelector',
                'logo-tapped': 'toggleAdSelector',
                'submit-tapped': 'toggleFinished',
                'create-ad-tapped': 'toggleCreateAd',
                'ad-creator-button-tapped': 'toggleAdSelector',
                'manage-ads-tapped': 'toggleAdManager',
                'sign-out-tapped': 'signOut'
            },

            dataChanged: function(newData, oldData) {
              console.log("data at query location changed!");
              console.log("Old Data: ");
              console.log(oldData);
              console.log("New Data: ");
              console.log(newData);
              console.log("Current Object State: ");
              console.log(this.queryData);

              //this.queryData[4].$key = "tester";
            },

            toggleLogin: function() {
                this.$$('#pages').selected = "1";
                this.canSignOut = true;
                this.canGoBack = false;
            },

            toggleUser: function() {
                this.$$('#pages').selected = "2";
                this.canSignOut = true;
                this.canGoBack = false;
            },

            toggleUniverseSelector: function() {
                this.$$('#pages').selected = "3";
                this.canSignOut = true;
                this.canGoBack = true;
            },

            toggleVendorSelector: function() {
                this.$$('#pages').selected = "4";
                this.canSignOut = true;
                this.canGoBack = true;
            },

            toggleAdSelector: function() {
                this.$$('#pages').selected = "5";
                this.canSignOut = true;
                this.canGoBack = true;
            },

            toggleCreateAd: function() {
                this.$$('#pages').selected = "6";
                this.canSignOut = true;
                this.canGoBack = false;
            },

            toggleAdManager: function() {
                this.$$('#pages').selected = "7";
                this.canSignOut = true;
                this.canGoBack = true;
            },

            toggleFinished: function() {
                this.$$('#pages').selected = "8";
                this.canSignOut = true;
                this.canGoBack = true;
            },

            goBack: function() {
                var page = this.$$('#pages').selected;

                if (page === "3" || page === "7" || page === "8") {
                    this.$$('#pages').selected = "2";
                    this.canGoBack = false;
                } else if (page === "4") {
                    this.$$('#pages').selected = "3";
                } else if (page === "5") {
                    this.$$('#pages').selected = "4";
                }

            },

            signOut: function() {
                this.$$('#pages').selected = "0";
                this.canSignOut = false;
                this.canGoBack = false;
            },

            ready: function() {
                console.log("Ready function executed.");
                console.log("=========================");
                console.log(this.urlQueryParamsString);

                // Convert the query to an Object:
                // NOTE - This code is copied from iron-query-params.html
                var paramString = this.urlQueryParamsString;
                var paramsObj = {};
                // Work around a bug in decodeURIComponent where + is not
                // converted to spaces:
                paramString = (paramString || '').replace(/\+/g, '%20');
                var paramList = paramString.split('&');
                for (var i = 0; i < paramList.length; i++) {
                    var param = paramList[i].split('=');
                    if (param[0]) {
                        paramsObj[decodeURIComponent(param[0])] =
                        decodeURIComponent(param[1] || '');
                    }
                }
                this.urlQueryParamsObject = paramsObj;
                console.log(this.urlQueryParamsObject);
                console.log("========================-");

                // If we were given a param object with an access token:
                // We are attempting to login,
                // Exchange it for an access token, and on success advance to the next page:
                if(this.urlQueryParamsObject.request_token != undefined)
                {
                    console.log("Found a request token!");
                    //TODO - attempting to login


                    // Exchanging the Request token for an access token:
                    // TODO - store these elsewhere
                    var exchangeURL = "https://authqa.the-pdi.com/accessTokens";
                    var appKey = "--redacted--";
                    //FIXME- it could be this one:
                    //var appKey = "--redacted--";
                    // or this one:
                    //var appKey = "--redacted--";

                    const httpRequest = new XMLHttpRequest();
                    httpRequest.open("POST",exchangeURL);
                    //httpRequest.setRequestHeader('Access-Control-Allow-Origin',exchangeURL);
                    httpRequest.setRequestHeader('Access-Control-Allow-Origin','*');
                    var formData = new FormData();
                    formData.append("RequestToken",this.urlQueryParamsObject.request_token);
                    formData.append("AppKey",appKey);
                    //var payload = {};
                    // Options: [EXTERN_ID,EMAIL,PHONE,GEN,DOBY,DOBM,DOBD,LN,FN,FI,CT,ST,ZIP,MADID,COUNTRY"]
                    //payload.schema = ["FN","LN","EMAIL","PHONE"];
                    //payload.data = [];
                    //payload.data.push(["Bill","Billy","bill@bill.com","1234567890"]);
                    //payload.data.push(["Bob","Bobby","bob@bob.com","5553332222"]);
                    //payload.data.push(["Steve","Stevey","steve@steve.com","2223334444"]);
                    //formData.append("payload",JSON.stringify(payload));

                    httpRequest.send(formData);

                    httpRequest.onreadystatechange=(e) => {
                        // If the httpRequest state is DONE (4)
                        if(httpRequest.readyState == 4) {
                            console.log("Token Exchange Response: ");
                            console.log("~~~~~~~~~~~~~~~~~~~~~~~~");
                            console.log(httpRequest);
                            console.log(httpRequest.responseText);
                            //var data = null;
                            //if(httpRequest.responseText) {
                            //    // JSONifying the response:
                            //    data = JSON.parse(httpRequest.responseText);
                            //    console.log(data);
                            //}
                            console.log("~~~~~~~~~~~~~~~~~~~~~~~~");
                        }
                    }
                }
            }

        });
    </script>
</dom-module>
